name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: store_api_test
          MYSQL_USER: store_user
          MYSQL_PASSWORD: MyPassword!
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: ğŸ—ï¸ Build with Maven
        run: ./mvnw clean compile -q

      - name: ğŸ§ª Run Tests
        run: ./mvnw test -q
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/store_api_test?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=UTC
          SPRING_DATASOURCE_USERNAME: store_user
          SPRING_DATASOURCE_PASSWORD: MyPassword!

      - name: ğŸ“Š Generate Coverage Report
        run: ./mvnw jacoco:report -q

      - name: ğŸ“ˆ Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./target/site/jacoco/jacoco.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: ğŸ” SonarQube Analysis (Optional)
        run: |
          ./mvnw sonar:sonar \
            -Dsonar.projectKey=store-api \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
            -q || true

      - name: ğŸ“¦ Build Docker Image
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: docker build -t ghassenebenslimene/store-api:latest -t ghassenebenslimene/store-api:${{ github.sha }} .

      - name: ğŸ³ Push to Docker Hub
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push ghassenebenslimene/store-api:latest
          docker push ghassenebenslimene/store-api:${{ github.sha }}

  lint:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: ğŸ” Check Code Style (SpotBugs)
        run: ./mvnw clean spotbugs:check -q || true

      - name: ğŸ¨ Check Formatting (Checkstyle)
        run: ./mvnw checkstyle:check -q || true

      - name: ğŸ“ Code Quality Analysis
        run: ./mvnw pmd:check -q || true

  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Run Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "store-api"
          path: "."
          format: "JSON"
          args: >
            --enableExperimental
            --enableRetired

      - name: ğŸ“¤ Upload Dependency Check Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: dependency-check-report
          path: reports/

  notify:
    runs-on: ubuntu-latest
    needs: [build-and-test, lint]
    if: always()

    steps:
      - name: ğŸ“¤ Notify on Success
        if: success()
        run: echo "âœ… Pipeline rÃ©ussi!"

      - name: âŒ Notify on Failure
        if: failure()
        run: echo "Pipeline Ã©chouÃ© - VÃ©rifiez les logs"
